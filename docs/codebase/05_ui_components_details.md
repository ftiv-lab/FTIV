# FTIV Codebase Documentation: `ui/components` Package (詳細版)

このドキュメントは `ui` パッケージ内の再利用可能なコンポーネント（Dialogs, Widgets）およびタブUIの実装詳細を解説するものです。

---

## 1. `ui/dialogs.py`

アプリケーション内で使用される汎用・専用ダイアログ群です。
多言語対応（i18n）や Undo/Redo のためのプレビュー機能を備えた高度なダイアログが含まれます。

### 基底クラス: `BaseTranslatableDialog`
言語切り替え（`languageChanged` シグナル）に追従してUIテキストを更新するための基底クラスです。
*   **`refresh_ui_text()`**: 抽象メソッド。サブクラスで翻訳更新処理を記述します。
*   **`_connect_language_changed()`**: 翻訳シグナルへ接続します。重複接続防止機構付き。
*   **`closeEvent()`, `accept()`, `reject()`**: どの経路で閉じても必ずシグナルを切断 (**disconnect**) する安全設計。

---

### 汎用ダイアログクラス

#### `SliderSpinDialog`
スライダーと数値入力ボックス（SpinBox）が同期する汎用調整ダイアログ。
*   線幅や透明度などの調整に使用されます。
*   `multiplier`: 小数を `QSlider` (整数のみ) で扱うための倍率係数。
*   **動作**: 値が変更されるたびに `callback` を即座に実行する（リアルタイム反映）。

#### `PreviewCommitDialog`
**「プレビュー中は反映するが、キャンセル時は戻す。OK時のみ確定する」** という挙動を実現するダイアログ。
Undo/Redo との相性が良く、変更履歴を汚さずに試行錯誤できます。
*   `on_preview(val)`: スライダー操作中に呼ばれる（Undoスタックに積まない軽量反映）。
*   `on_commit(val)`: OKボタン押下時に一度だけ呼ばれる（ここで Undo コマンドを生成・登録する）。
*   `_initial`: キャンセル時にこの値を `on_preview` に投げて元に戻す。

#### `TextInputDialog` (継承: `BaseTranslatableDialog`)
テキスト入力・編集用の高機能ダイアログ。
*   **機能**:
    *   テキスト入力エリア（`QTextEdit`）。
    *   フォント変更機能（`QFontDialog` 連携）。
    *   設定保存（次回起動時にウィンドウサイズやフォント設定を復元）。
    *   `Ctrl+Enter` ショートカットによる確定。
*   **日本語入力対応**: Windows環境でのフォントフォールバック問題（絵文字化けなど）に対処するため、表示用には `Segoe UI` などを優先しつつ、データとしては指定フォントを保持する工夫が入っています。

---

### 専用プロパティダイアログ

#### `MarginRatioDialog`
マージン（余白）率を設定するシンプルな入力ダイアログ（0.0〜1.0）。

#### `ShadowOffsetDialog`
影のオフセット（X, Y）を調整するダイアログ。
*   X軸、Y軸それぞれにスライダーとSpinBoxを持ちます。
*   モーダル表示でリアルタイムプレビュー (`callback`) に対応。

#### `ShadowScaleDialog`
影の拡大縮小率を設定するダイアログ（0.01〜10.0）。

#### `GradientEditorDialog` (継承: `BaseTranslatableDialog`)
グラデーション作成・編集用の高度なエディタ（v1.1）。
左側にプレビュー/操作ウィジェット、右側に選択中のストップ（色・位置）の詳細設定パネルを配置。
*   **構成**: `Gradient` ウィジェット（後述）を埋め込んで使用。
*   **機能**:
    *   角度指定（スライダー/SpinBox）。
    *   ストップ（分岐点）の追加・削除・位置調整。
    *   各ストップの色選択。
    *   `hint_label`: 操作方法（追加、削除など）のヘルプを表示。

---

## 2. `ui/widgets.py`

カスタム描画を行う独自ウィジェット定義です。

### クラス: `Gradient(QWidget)`
グラデーションのバーを表示し、マウス操作でストップポイントを編集できるUI部品。
`GradientEditorDialog` 内で使用されます。

#### プロパティ
*   `_gradient`: `[(stop(0.0-1.0), hex_color), ...]` のリスト。位置順にソートされて保持されます。
*   `_angle`: グラデーション角度。
*   `_selected_index`: 現在選択されているハンドルのインデックス。

#### 描画処理 (`paintEvent`)
1.  **背景**: 現在の設定で `QLinearGradient` を作成し、矩形全体を塗りつぶしてプレビュー表示します。
2.  **ハンドル**: 各ストップ位置に「つまみ（ハンドル）」を描画します。選択中のハンドルは青枠で強調されます。

#### イベント処理
*   **マウス操作**:
    *   **左クリック**: ハンドル選択。何もない場所なら選択解除。
    *   **左ドラッグ**: ハンドルの位置移動。移動中はソートせず、離した瞬間にソートしてインデックスを再計算します。
    *   **ダブルクリック**:
        *   ハンドル上: カラーダイアログを開く。
        *   ハンドル外: その位置に新しいストップを追加。
    *   **右クリック**: ハンドルを選択しつつカラーダイアログを開く（ショートカット）。
*   **キー操作**:
    *   `Delete` / `Backspace`: 選択中のストップを削除（ただし両端 0% と 100% は削除不可）。

#### シグナル
*   `gradientChanged`: グラデーション構成（色、位置、角度）が変わった時。
*   `selectedStopChanged(int)`: 選択ハンドルが変わった時（右パネルの表示更新用）。

---

## 3. `ui/tabs/` (概要)

`PropertyPanel` (右サイドバー) で表示されるタブごとのUI実装です。
それぞれ `QWidget` を継承し、対応する `MainWindow` やマナージャの機能を呼び出します。

*   **`text_tab.py`**: テキスト操作用。テキスト内容編集、フォント、装飾、配置アクションなどのボタン群。
*   **`image_tab.py`**: 画像操作用。回転、反転、不透明度、アニメ速さ調整などのコントロール。
*   **`scene_tab.py`**: シーン管理タブ (`SceneTab`) およびコネクタ管理タブ (`ConnectionsTab`)。コネクタの選択・編集ロジック（色、線幅、ラベル操作等）もここに集約されています。
*   **`general_tab.py`**: アプリ設定（言語、最前面、テーマなど）。
*   **`animation_tab.py`**: アニメーション（移動、フェード）の詳細設定。イージング選択のコンボボックスなどを持つ。
*   **`about_tab.py`**: アプリ情報、ライセンス表示（HTMLビューア）。

これらは `MainWindow` の `setup_ui` でインポートされ、`QTabWidget` に追加されます。
ボタンクリック時のスロットは、主に `ui.controllers` パッケージのアクションメソッドや `MainWindow` のメソッドに接続されます。
