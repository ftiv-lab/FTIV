# Phase 12: Reliability & Prevention Standards (品質保証と再発防止)

Phase 11 までの教訓（特に「直近の構造変更を認識せず、古い構造を前提にコードを書いてしまう」ミス）を踏まえ、今後の開発における**厳格な品質保証プロセス**と**再発防止策**を定義します。

## 1. 目的
*   **「思い込みミス (Assumption Errors)」の根絶**: UI構造などの変更が、使用する側（Manager/Controller）に正しく伝わっているかを機械的に保証する。
*   **リグレッションの早期検知**: 手動確認に頼らず、自動テストで「画面が壊れていないか」を検知する。
*   **開発ルールの厳格化**: 人力でのミスを防ぐための、エージェント行動指針のアップデート。

## 2. 具体的なアクション計画

### A. 開発ルールの改訂（即時適用）
Antigravity プログラミング・スタンダードに以下を追加・徹底します。

1.  **「UI探索の禁止」と「明示的な依存注入」**
    *   ❌ BAD: `if hasattr(self.mw, 'btn_start'): ...` (あるかどうかわからないものを探る)
    *   ⭕ GOOD: `self.mw.animation_tab.btn_start` (存在するはずのパスを明確に指定し、なければ即座にエラーにする＝**Fail Fast原則**)
    *   **理由**: `hasattr` や `try-except` で握りつぶすと、UI構造が変わったことに気づけず、機能が「黙って動かなくなる」ため。

2.  **「構造確認」の義務化**
    *   コード修正前に、必ず対象コンポーネントの `__init__` や `setup_ui` を `view_file` し、現在のUI階層（どのTabの配下にあるか等）を事実確認する。記憶や推測に頼ることを禁止する。

### B. 自動テスト環境の強化（Structural Integrity Tests）
「UIパーツが本当に存在するのか」を検証するテストを導入します。

1.  **UI構造整合性テスト (`tests/test_ui_structure.py`) の作成**
    *   **内容**: `MainWindow` および各 `Tab` クラスをインスタンス化（ヘッドレス）し、Controller/Manager がアクセスする予定の主要ウィジェット（`btn_...`, `chk_...`）が**実際に属性として存在するか**をチェックする。
    *   **効果**: 「ボタン名を変更した」「タブを移動した」際に、テストが落ちることで即座に検知できる。

2.  **静的解析スクリプトの導入 (`tools/check_ui_refs.py`)**
    *   **内容**: ソースコードを走査し、`self.mw.xxx` 形式のアクセスを抽出。`MainWindow` クラス定義と比較し、定義されていない属性へのアクセスを警告する簡易スクリプト。

### C. ワークフローの見直し（Pre-flight Check）
タスク開始時のプロセスに以下を追加します。

1.  **「影響範囲の現況調査」フェーズの厳格化**
    *   タスク着手前に、関連するファイル（特にUI定義とそれを使うLogic）の**最新の diff** または **全文** を確認するステップを設ける。
    *   「前回こうだったから」という前提を捨て、毎回ゼロベースで構造を確認する。

## 3. 実装ステップ（Phase 12 タスク）

1.  **[Rule] 開発ルールのドキュメント化とメモリへの登録**
    *   ユーザー定義メモリ（`user_global`）への追記案作成。
2.  **[Test] UI構造整合性テストの実装**
    *   `pytest` ベースで、実際にアプリを起動せずにクラス構造を検査するテストを作成。
3.  **[Tool] 参照監査スクリプトの作成**
    *   `grep` よりも賢く、PythonのAST（抽象構文木）を用いて「怪しいアクセス」を検出するツールを作成。
4.  **[CI] テスト実行のルーチン化**
    *   変更を加えた後は必ず上記テストを実行してから `notify_user` するフローを確立。

## 4. 期待される効果
*   UIリファクタリング後の「ボタンが反応しない」「設定が効かない」といった不具合が、コードを書いた瞬間に（または直後のテストで）判明するようになります。
*   エージェントが「古い構造」に基づいてコードを書こうとした際、事前の構造確認プロセスで気づけるようになります。
