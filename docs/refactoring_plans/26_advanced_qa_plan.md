# Phase 13: Advanced Quality Assurance & Safety Net (深化された品質保証)

Phase 12 で「構造的な整合性」は担保されましたが、ユーザー体験（UX）や「実際に動かしたときの挙動」を保証するには、もう一歩踏み込んだ対策が有効です。
以下の取り組みを提案します。

## 1. 目的
*   **「動かしてみたら動かない」の完全排除**: 静的解析ではわからない、イベント連鎖や状態遷移のバグを防ぐ。
*   **コード品質の自動維持**: 開発者の「注意」に頼らず、ツールがコードの綺麗さと正しさを強制する。
*   **実環境での堅牢性**: ユーザー環境での予期せぬクラッシュを防ぐ自己診断機能を搭載する。

## 2. 具体的なアクション計画

### A. GUI操作の自動化テスト (Interactive E2E Tests)
現状の単体テストは「ロジック」が中心です。「ボタンを押したらウィンドウが開く」「数値を変更したら画面が更新される」といった**ユーザー操作**をシミュレートするテストを導入します。

*   **ツール**: `pytest-qt` (PySide6対応のテストプラグイン)
*   **対象**:
    *   **クリティカルパス**: アプリ起動 → テキスト追加 → 保存 → 読み込み がエラーなく完走するか。
    *   **ダイアログ操作**: 設定画面を開き、変更して閉じた後に反映されているか。
    *   **ショートカットキー**: Ctrl+S や Ctrl+Z が正しく機能するか。

### B. 静的解析の厳格化と自動整形 (Strict Linting & Formatting)
コードの書き方を統一し、潜在的なバグ（未定義変数の使用、不要なインポート、複雑すぎる関数）を機械的に排除します。

*   **ツール**: `Ruff` (高速で厳格なLinter)
*   **ルール**:
    *   **F (Pyflakes)**: 文法エラーや未定義参照の検出
    *   **E/W (pycodestyle)**: PEP8準拠チェック
    *   **I (isort)**: インポート順序の自動整理（循環参照防止に寄与）
*   **運用**: ファイル保存時またはコミット前に自動修正をかける設定を推奨。

### C. ランタイム自己診断 (Runtime Guardians)
アプリ起動時に「健康診断」を行い、異常があれば安全に修復するか、分かりやすい警告を出します。

*   **Config Validator**: `settings.json` が壊れていたり、不正な値（無効なパスや型違い）が入っていないか起動時に検証・補正する。
*   **Resource Checker**: 必要な画像/アセット/ロケールファイルが存在するかチェックし、欠落している場合はデフォルトに戻す等の処理を入れる。
*   **Object Graph Audit**: ウィンドウとマネージャーの接続関係が正しいか、定期的に（またはデバッグモード時に）チェックする診断モードの実装。

### D. ローカルCIスクリプト (One-Click Verify)
「これを実行して通ればリリースしてOK」と言える、全チェックを一括実行するバッチファイルを作成します。

*   `verify_all.bat`:
    1.  `ruff check .` (コードスタイル確認)
    2.  `python tools/check_ui_refs.py` (UI参照監査)
    3.  `pytest` (全テスト実行)
    *   これらを順次実行し、一つでも失敗したら警告音を鳴らす。

## 3. 実装ステップ（Phase 13 案）

1.  **[Tool] Ruff の導入と設定** (`pyproject.toml` 作成)
2.  **[Test] pytest-qt による GUI操作テストの実装** (`tests/test_interactive/`)
3.  **[Feature] 起動時コンフィグバリデーターの実装** (`managers/config_guardian.py`)
4.  **[Script] verify_all.bat の作成**

## 4. 期待される効果
*   「ちょっといじったら動かなくなった」という単純なデグレードが、開発者の手元で即座に検知されます。
*   リリース後のユーザーから「設定ファイルが壊れて起動しない」といった報告が激減します。
*   コードベース全体が常にクリーンに保たれ、将来の機能追加が容易になります。
