# Tasks

- [x] Planning Property Panel Decoupling <!-- id: 0 -->
    - [x] Explore existing PropertyPanel implementation <!-- id: 1 -->
    - [x] Create Implementation Plan <!-- id: 2 -->
- [x] Implement Property Panel Changes <!-- id: 3 -->
- [x] Verify Changes <!-- id: 4 -->
- [x] Fix Font Change Crash (Regression) <!-- id: 38 -->
    - [x] Fix PySide6 Dialog Return Value Bug <!-- id: 39 -->
    - [x] Audit Other Dialogs <!-- id: 40 -->
- [x] Update Instruction Window <!-- id: 5 -->
    - [x] Locate Instruction Window code <!-- id: 6 -->
    - [x] Plan and Implement Window Flag Changes <!-- id: 7 -->
    - [x] Verify Instruction Window <!-- id: 8 -->
- [x] Fix Instruction Window Styling <!-- id: 9 -->
    - [x] Investigate Stylesheet Scope <!-- id: 10 -->
    - [x] Apply Dark Theme to Independent Window <!-- id: 11 -->
    - [x] Verify Styling (Manual) <!-- id: 12 -->
- [x] Consulting on Release Strategy <!-- id: 13 -->
    - [x] Analyze Build & Edition Logic <!-- id: 14 -->
    - [x] Create Strategic Report (Free vs Pro) <!-- id: 15 -->
- [x] Implement Unified Release <!-- id: 16 -->
    - [x] Update utils/edition.py (Remove Limits) <!-- id: 17 -->
    - [x] Update build_release.py (Single Build) <!-- id: 18 -->
    - [x] Update UI & Docs (About Tab, etc) <!-- id: 19 -->
    - [x] Verify Unified Release (verify_all) <!-- id: 20 -->

- [x] **v1.0.1 Patch Release (Safety First)** <!-- id: 41 -->
    - [x] Update Version Strings (Code, Docs) <!-- id: 42 -->
    - [x] Build v1.0.1 Release (FTIV.zip) <!-- id: 43 -->
    - [x] Final Verification <!-- id: 44 -->

- [ ] **Post-v1.0.1 Refactoring Verification** <!-- id: 45 -->
    - [x] Run `verify_all.bat` (Lint/Test/UI Check) <!-- id: 46 -->
    - [x] Validate `SpacingSettings` against Standards <!-- id: 47 -->
    - [x] Verify `InlineEditor` Improvements <!-- id: 48 -->

- [ ] **Phase 3: Strict Interface Refactoring (Reliability)** <!-- id: 50 -->
    - [x] Research `hasattr` usage hotspots <!-- id: 51 -->
    - [x] Define `ConfigurableWindow` Protocol/Interface <!-- id: 52 -->
    - [x] Create Implementation Plan <!-- id: 53 -->
    - [x] Verification: Mypy/Type Check (Completed via test_protocols.py) <!-- id: 54 -->
    - [x] **Fix: Inline Editor Spacing Mismatch** <!-- id: 55 -->
        - [x] Calculate padding in `InlineEditorMixin` <!-- id: 56 -->
        - [x] Sync with `TextRenderer` logic <!-- id: 57 -->
    - [x] **Refine: Inline Editor UX (Floating/Resizing)** <!-- id: 58 -->
        - [x] Implement Parent Resizing Strategy (+Safety Margin) <!-- id: 59 -->
        - [x] Enforce Min-Width for Vertical Mode <!-- id: 60 -->
    - [x] **Phase 2: Editor-Driven Sizing logic** <!-- id: 61 -->
        - [x] Enable `NoWrap` mode in `InlineEditorMixin` <!-- id: 62 -->
        - [x] Implement `document().size()` based resizing <!-- id: 63 -->
    - [x] **Phase 3: Robust Expansion (Active Metric Sizing)** <!-- id: 64 -->
        - [x] Implement `blockCount * lineSpacing` calculation <!-- id: 65 -->
        - [x] Fix Enter key scrolling/clipping issue <!-- id: 66 -->
    - [x] **Phase 4: Stabilizing (Flicker Fix)** <!-- id: 67 -->
        - [x] Implement Geometry Bypass in `TextRenderer` <!-- id: 68 -->
    - [x] **Phase 5: Vertical "Adaptive Reset"** <!-- id: 69 -->
        - [x] Reset `min_edit_h` for vertical mode preventing huge empty space <!-- id: 70 -->

- [x] **Spacing System Split (Vertical/Horizontal De-coupling)** <!-- id: 75 -->
    - [x] Create Implementation Plan (High Resolution)
    - [x] Model: Add `char_spacing_h/v` and `line_spacing_h/v` to `TextWindowConfig`
    - [x] Renderer: Update `TextRenderer` to use separate properties
    - [x] UI: Update `TextSpacingDialog` to handle split settings
    - [x] Undo/Redo: Update `PropertyChangeCommand` logic if needed
    - [x] Verification: Test Independence with `pytest` (`test_spacing_split.py`)
    - [x] Bugfix: Horizontal Character Overlap (High Res Verification)
    - [x] **Refactoring: Vertical Text Metrics** <!-- id: 70 -->
        - [x] Test: Add `test_vertical_spacing_metrics` (Red -> Green)
        - [x] Fix: Replace `font_size` step with `QFontMetrics.height()`
        - [x] Fix: Remove magic numbers in `_get_vertical_char_transform`
    - [x] **Refinement: Vertical Spacing & Cutoff Fix** <!-- id: 76 -->
        - [x] Fix: Use `Ascent + Descent` instead of `Height` (Remove massive gaps)
        - [x] Fix: Sync `_render_vertical` size calculation with rendering logic (Fix Cutoff)
        - [x] Fix: Sync `_render_vertical` size calculation with rendering logic (Fix Cutoff)
        - [x] Verify: Update `test_spacing_split.py` expectations
    - [x] **Fix: Vertical Text Positioning (Double Compensation)** <!-- id: 82 -->
    - [x] Fix: Remove `shadow_x` from `curr_x` calculation in `_draw_vertical_text_content`

- [x] **Fix: Vertical Punctuation Alignment (Typographic)** <!-- id: 83 -->
    - [x] Implementation: Update `_get_vertical_char_transform` for Em-box alignment
    - [x] Implementation: Logic for Quadrant Mapping (、。)
    - [x] Implementation: Optical Centering for Rotated Chars

- [ ] **Cleanup: Remove Legacy Settings (Type A/B)** <!-- id: 84 -->
    - [x] Model: Remove `OffsetMode` from `enums.py` and `window_config.py`
    - [x] UI: Remove Type A/B selectors from `MainWindow`
    - [x] UI: Remove Context Menu options from `TextWindow`
    - [x] Controller: Remove `set_offset_mode` actions
    - [x] **Fix: Vertical Width Cutoff (Adaptive Column Width)** <!-- id: 78 -->
        - [x] Fix: Implement `col_width = max(font_size, max_char_width)` in `text_renderer.py`

- [x] **Refinement: Shadow Geometry (Offset & Clipping)** <!-- id: 80 -->
    - [x] Plan: Analyze Coordinate System and Canvas Logic
    - [x] Fix: `_apply_blur_to_pixmap` Coordinate Mapping (Prevent Shift)
    - [x] Fix: Canvas Calculation (Add Blur/Offset padding)
    - [x] Verify: Visual Audit of Offsets and Clipping

- [x] **Fix: Vertical Shadow Alignment (Layout Locking)** <!-- id: 81 -->
    - [x] Implementation: Add `layout_font` to `_draw_vertical_text_content`
    - [x] Implementation: Use `layout_font` for metrics calculation
    - [x] Implementation: Pass main font as anchor from `_draw_vertical_text_elements`

- [x] **Settings Audit & Default Management** <!-- id: 71 -->
    - [x] Audit: Default Settings Management
    - [x] High-resolution audit of margins, spacing, and fonts
    - [x] Identification of gaps in "Set as Default" functionality
    - [x] Propose and implement global default inheritance
        - [x] Implement archetype-based default system (Archetype Architecture)
            - [x] Modify `SettingsManager` to handle `text_archetype.json`
            - [x] Update `WindowManager.add_text_window` to apply archetype
            - [x] Implement `TextActions.save_as_default` logic
        - [x] Fix vertical defaults loading bug
        - [x] UI Enhancements: "Save as Default" Buttons
            - [x] Add button to `PropertyPanel` (Style sections)
            - [x] Add button to `MainWindow.TextTab` (Layout subtab)
        - [x] Verification: Archetype Persistence Test

- [x] **Distribution Phase** <!-- id: 21 -->
    - [x] Fix Nuitka Build (VirusTotal False Positives) <!-- id: 22 -->
    - [x] Update Documentation (README.md, git_guide.md) <!-- id: 23 -->
    - [x] Create Distribution Strategy Plan <!-- id: 24 -->
    - [x] Push to GitHub (ftiv-lab/FTIV) <!-- id: 25 -->
    - [x] Create GitHub Release (v1.0.0) <!-- id: 26 -->
    - [x] Setup GitHub Pages <!-- id: 27 -->

- [ ] **Phase 3: Growth & Education Strategy** <!-- id: 28 -->
    - [x] Create High-Resolution Strategic Plan (Roles & Roadmap) <!-- id: 29 -->
        - [ ] Marketing Strategy (Awareness) <!-- id: 30 -->
            - [x] Create Professional Landing Page (like NeeView) <!-- id: 33 -->
        - [ ] EdTech Strategy (Online Course) <!-- id: 31 -->
            - [ ] Write Zenn/Qiita Article: "How I Survived GitHub Ban" <!-- id: 37 -->
    - [ ] Execution of Short-term Growth Tactics <!-- id: 32 -->

- [x] **Phase 4: Crisis Management (Account Suspension)** <!-- id: 34 -->
    - [x] Appeal to GitHub Support <!-- id: 35 -->
    - [x] Wait for Account Reinstatement <!-- id: 36 -->

- [ ] **Phase 6: Modern Dev Environment (Super Senior Stack)** <!-- id: 90 -->
    - [x] **Phase 1: UV Adoption (Speed & Reliability)** <!-- id: 91 -->
        - [x] Install `uv` <!-- id: 92 -->
        - [x] Migrate `pyproject.toml` dependencies <!-- id: 93 -->
        - [x] Update `verify_all.bat` to use `uv run` <!-- id: 94 -->
        - [x] Verify `uv` workflow <!-- id: 95 -->
    - [ ] **Phase 2: Type Safety (Mypy)** <!-- id: 96 -->
        - [x] Configure `mypy` in `pyproject.toml` <!-- id: 97 -->
        - [x] Baseline Check & Fix (or Ignore) <!-- id: 98 -->
        - [x] **Phase 1: Syntax Cleanup** <!-- id: 101 -->
            - [x] Enable `valid-type` (Fix `callable`) <!-- id: 102 -->
            - [x] Enable `no-redef` (Fix shadowing) <!-- id: 103 -->
            - [x] Enable `name-defined` (Fix missing names) <!-- id: 104 -->
            - [x] Verify Phase 1 <!-- id: 105 -->
        - [x] **Phase 2: The Qt Trap (Call Overloads)** <!-- id: 106 -->
            - [x] Fix `QPoint`/`QSize` mismatches (`dialogs.py`, `text_window.py`) <!-- id: 107 -->
            - [x] Fix `QAction` parent casting (`ShortcutMixin`) <!-- id: 108 -->
            - [x] Fix `InlineEditor` parent compatibility <!-- id: 109 -->
            - [x] Fix `Translator` override signature <!-- id: 110 -->
            - [x] Verify Zero Errors <!-- id: 111 -->
        - [x] **Phase 3: The Null Menace (Strict Optional)** <!-- id: 112 -->
            - [x] Enable `strict_optional = true` <!-- id: 113 -->
            - [x] Verify Zero Errors (Instant Win!) <!-- id: 114 -->
    - [x] **Phase 3: Automation (Pre-commit)** <!-- id: 99 -->
        - [x] Install & Configure `pre-commit` <!-- id: 100 -->
    - [x] **Phase 4: Documentation (Super Senior Stack)** <!-- id: 115 -->
        - [x] Update AGENT_READING_LIST.md
        - [x] Update RULES_AND_STANDARDS.md
        - [x] Update CONTRIBUTING.md
        - [x] Fix Missing Translations (Margin Settings)

- [ ] **Phase 7: Global Style System (Theming)** <!-- id: 116 -->
    - [x] **Phase 1: Infrastructure** <!-- id: 117 -->
        - [x] Create `assets/style/theme.qss.template` <!-- id: 118 -->
        - [x] Create `utils/theme_manager.py` (Variable Preprocessor) <!-- id: 119 -->
        - [x] Initialize `ThemeManager` in `main.py` <!-- id: 120 -->
        - [x] Verify hot-reload capability <!-- id: 121 -->
    - [x] **Phase 2: Component Migration** <!-- id: 122 -->
        - [x] Extract Buttons to Semantic Classes (`primary`, `danger`, `action`) <!-- id: 123 -->
        - [x] Extract Labels and Panels <!-- id: 124 -->
    - [x] **Phase 3: Tab Migration (De-coupling)** <!-- id: 125 -->
        - [x] Refactor `ImageTab` (Remove `setStyleSheet`) <!-- id: 126 -->
        - [x] Refactor `TextTab` <!-- id: 127 -->
        - [x] Refactor `GeneralTab` etc. <!-- id: 128 -->
    - [x] **Phase 4: Regressions & Refining** <!-- id: 129 -->
        - [x] Restore Background Toggle & Border Settings in PropertyPanel <!-- id: 130 -->
        - [x] Fix: Background Toggle actually affects rendering <!-- id: 131 -->
    - [x] **Phase 5: Gradient UI Integration** <!-- id: 132 -->
        - [x] Add Translation Keys (`jp.json`) <!-- id: 133 -->
        - [x] Implement Text Gradient Controls in PropertyPanel <!-- id: 134 -->
        - [x] Implement Background Gradient Controls in PropertyPanel <!-- id: 135 -->
        - [x] Verify Gradient Sync & UX <!-- id: 136 -->
    - [ ] **Phase 6: Reliability & Safety Net** <!-- id: 137 -->
        - [x] **Step 1: Persistence Assurance (E2E Test)** <!-- id: 138 -->
            - [x] Create `tests/test_e2e_persistence.py` <!-- id: 139 -->
            - [x] Implement Process-based Restart Test Strategy <!-- id: 140 -->
            - [x] Verify Settings Preservation (Gradient, Layout, etc.) <!-- id: 141 -->
        - [x] **Step 2: Factory Reset Logic** <!-- id: 142 -->
            - [x] Refactor `scripts/reset_defaults.py` into `ResetManager` <!-- id: 143 -->
            - [x] Implement Backup Logic (`config.json.bak`) <!-- id: 144 -->
        - [x] **Step 3: Factory Reset UI** <!-- id: 145 -->
            - [x] Create `ResetDialog` (Safety Confirmation) <!-- id: 146 -->
            - [x] Add "Danger Zone" to `GeneralTab` <!-- id: 147 -->
            - [x] Verify Reset Flow (Manual) <!-- id: 148 -->
        - [x] **Step 4: Smart Reset Refinement (Granular Control)** <!-- id: 149 -->
            - [x] Model: Update `ResetManager` to accept flags <!-- id: 150 -->
            - [x] UI: Add Checkboxes to `ResetConfirmDialog` <!-- id: 151 -->
            - [x] Verify: Test Selective Deletion <!-- id: 152 -->
        - [x] **Step 5: Refine Spacing UI & Terminology** <!-- id: 153 -->
            - [x] Create Proposal (`spacing_ui_refinement_proposal.md`) <!-- id: 154 -->
            - [x] Update Localization Keys (`jp.json`/`en.json`) <!-- id: 155 -->
            - [x] Fix Default Spacing Values (`0.0`) in `models` <!-- id: 156 -->
            - [x] Update UI Labels and Buttons (`TextSpacingDialog`, `TextTab`) <!-- id: 157 -->
    - [x] **Fix: Regressions (Persistence & UI)** <!-- id: 158 -->
        - [x] Fix: `ResetManager` ignoring `text_defaults.json` (0.5 bug) <!-- id: 159 -->
        - [x] Fix: `TextTab` "Set as Default" button language update bug <!-- id: 160 -->
        - [x] Fix: `ResetConfirmDialog` Missing Keys/Translations <!-- id: 161 -->
        - [x] Fix: `TextWindowConfig` hardcoded `0.5` defaults (True Root Cause) <!-- id: 162 -->
        - [x] Fix: `TextTab` Orientation Toggle Key Mismatch <!-- id: 163 -->

