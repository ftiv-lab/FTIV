# 影の描画改善プラン (Shadow Refinement Plan)

## 現在の問題点 (Current Issues)

1.  **オフセット0でのズレ (Offset 0 Shift)**
    *   **現象**: 影のオフセットを(0, 0)に設定しても、右下にズレて表示される（浮いているように見える）。
    *   **根本原因**: `_apply_blur_to_pixmap` 内での座標マッピングの問題です。`QGraphicsBlurEffect` は画像をぼかす際、境界ボックスを拡張します（例: -10px から +10px）。`scene.render(p)` を引数なしで呼び出すと、この*拡張された* `sceneRect()` 全体が、元のサイズの `QPixmap` にレンダリングされます。その結果、拡張された矩形の左上（例: -10, -10）が結果の左上(0, 0)にマッピングされ、ぼかし半径の分だけ画像がズレてしまいます。
    *   **修正案**: `scene.render` で `source` (描画元) と `target` (描画先) の矩形を明示的に指定します。マッピングを `QRectF(pixmap.rect())` に固定することで、(0,0) が (0,0) のまま維持されるようにします。

2.  **影の見切れ (Shadow Clipping)**
    *   **現象**: オフセットを大きくしたり、ぼかしを強くしたりすると、影の端が切れてしまう。
    *   **根本原因**: `_render_horizontal` および `_render_vertical` における `canvas_size` (キャンバスサイズ) の計算ロジックが不十分です。
        *   `window.shadow_blur` (ぼかし半径) が計算に含まれておらず、ぼかしが広がる分の余地がありません。
        *   負の `shadow_offset` (左や上への影) が無視されています（`max(offset, 0)` のみが考慮されている）。
        *   固定のマージンに依存しており、影がマージンを超えて広がると見切れてしまいます。
    *   **修正案**: `canvas_size` の計算ロジックを刷新し、以下を正確に加算します。
        *   `abs(shadow_offset)` (全方向のオフセット絶対値)
        *   `blur_radius` のパディング（フェードアウト分の余白）

## 提案する変更 (Proposed Changes)

### 1. `_apply_blur_to_pixmap` の修正（座標ロック）

`scene.render` を修正し、1:1 のマッピングを強制します。

```python
# 1:1 マッピングを強制: ソース矩形 == ターゲット矩形 == 元のPixmap矩形
rect = QRectF(pixmap.rect())
scene.render(p, target=rect, source=rect)
```
*補足*: ぼかしが元のコンテンツの外側に広がる必要がある場合は、次のステップ（キャンバスサイズの拡張）で確保された余白（マージン）を利用します。ここでマッピングをロックすることで、意図しないズレを防ぎます。

### 2. キャンバスサイズ計算の修正（バウンディングボックス拡張）

`_render_horizontal` と `_render_vertical` を更新します。

**ロジックの概要:**

**「コンテンツ矩形」と「キャンバス矩形」の分離**
*   **コンテンツ矩形**: テキスト本体が存在する領域。
*   **影矩形**: コンテンツ矩形をシフトし、ぼかし分拡張した領域。
*   **キャンバス矩形**: コンテンツ矩形と影矩形を包含する最小の矩形。

**実装詳細:**
1.  テキストの幅・高さを計算 (`text_width`, `text_height`)。
2.  `shadow_extents` (影の広がり) を計算 (上下左右)。
    *   左への広がり: `min(0, shadow_x - blur)`
    *   右への広がり: `max(0, shadow_x + blur)`
    *   上下も同様。
3.  キャンバス幅・高さの算出:
    *   `canvas_width = text_width + abs(左広がり) + 右広がり + マージン`
    *   `canvas_height = text_height + abs(上広がり) + 下広がり + マージン`
4.  **重要**: 描画時、ペインターの原点を `(m_left + abs(左広がり), m_top + abs(上広がり))` に `translate` (移動) させます。これにより、左や上に影が伸びても見切れることなく描画されます。

### 3. 縦書きモードへの適用

縦書きモードでも同様のロジックを適用します。
既に実装済みの「Adaptive Column Width (適応型列幅)」は「コンテンツ矩形」の一部となります。その周囲に影の広がりを加算します。

## 検証計画 (Verification Plan)

1.  **目視確認 (Visual Verify)**:
    *   影オフセット (0, 0)、ぼかし 20 に設定 → 影が完全に中心にあり、均等なハロー（後光）となること。
    *   影オフセット (-20, -20) に設定 → 左上に影がはっきりと見え、キャンバスが自動拡張されて見切れていないこと。
    *   大きなぼかしとオフセットを設定しても、ウィンドウが見切れないこと。
