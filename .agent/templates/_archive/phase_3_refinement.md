# Phase 3: Refinement (Claude担当)

**Task ID**: `{{TASK_ID}}`
**Task Title**: `{{TASK_TITLE}}`
**Started**: `{{START_TIME}}`
**AI**: Claude ({{MODEL_NAME}})

---

## 📖 開始前の必読ドキュメント

```bash
# 必ず最初に読んでください
cat .ftiv-task/{{TASK_ID}}/implementation_log.md
cat .ftiv-task/{{TASK_ID}}/handoff_to_claude.md
```

**目的**: Gemini実装をレビューし、品質・保守性・セキュリティを向上させる。
**原則**: 過剰設計は避け、必要最小限の改善のみ実施する。

---

## 1️⃣ コードレビューチェックリスト

`.agent/roles/code-reviewer.md` の基準に従ってレビューしてください。

### 🏗️ アーキテクチャ
- [ ] **設計意図との整合性**: Design Specの意図が正しく反映されているか？
- [ ] **責務の分離**: 各クラスが単一責任を持っているか？
- [ ] **適切な抽象化**: 過剰でも不足でもない抽象化レベルか？
- [ ] **既存構造との調和**: 既存コードベースのパターンに準拠しているか？

**問題点**:
- [問題1: 例: XXXクラスが複数の責務を持っている]
  **対処**: [YYYクラスに分離]

---

### 🔒 セキュリティ（OWASP Top 10）
- [ ] **インジェクション**: SQL, Command, XSS等の脆弱性はないか？
- [ ] **認証・認可**: 権限チェックは適切か？（該当する場合）
- [ ] **機密データ露出**: ログ・エラーメッセージに機密情報が含まれないか？
- [ ] **XXE**: XML外部エンティティ攻撃の可能性はないか？
- [ ] **入力検証**: ユーザー入力のバリデーションは十分か？

**問題点**:
- [セキュリティ上の問題があれば記載]
  **対処**: [修正内容]

**該当なし**: ✅ セキュリティリスクは検出されませんでした

---

### 🎯 SOLID原則
- [ ] **Single Responsibility**: 各クラスが単一の変更理由のみを持つか？
- [ ] **Open/Closed**: 拡張に開放、修正に閉鎖されているか？
- [ ] **Liskov Substitution**: 継承関係が正しいか？（継承がある場合）
- [ ] **Interface Segregation**: 不要なメソッド依存はないか？
- [ ] **Dependency Inversion**: 具象ではなく抽象に依存しているか？

**問題点**:
- [SOLID違反があれば記載]
  **対処**: [修正内容]

---

### 🧪 テスト容易性
- [ ] **モック可能**: 外部依存をモック化できるか？
- [ ] **副作用の分離**: 副作用を持つ処理が明確に分離されているか？
- [ ] **テスタブルな設計**: ユニットテストが書きやすい構造か？

**問題点**:
- [テスト容易性の問題があれば記載]
  **対処**: [修正内容]

---

### 📝 コード品質
- [ ] **命名規則**: 変数・関数・クラス名が明確で一貫しているか？
- [ ] **重複コード**: DRY原則に従っているか？
- [ ] **マジックナンバー**: ハードコードされた値が定数化されているか？
- [ ] **エラーハンドリング**: 適切な例外処理がされているか？
- [ ] **型ヒント**: Python型ヒントが適切に付与されているか？
- [ ] **docstring**: 重要なクラス・メソッドにドキュメント文字列があるか？

**問題点**:
- [コード品質の問題があれば記載]
  **対処**: [修正内容]

---

### ⚡ パフォーマンス
- [ ] **アルゴリズム効率**: 不要なループ・計算はないか？
- [ ] **メモリ使用**: メモリリークの可能性はないか？
- [ ] **N+1問題**: 繰り返しのデータベース/ファイルアクセスはないか？

**問題点**:
- [パフォーマンス問題があれば記載]
  **対処**: [修正内容]

**該当なし**: ✅ パフォーマンス上の問題は検出されませんでした

---

## 2️⃣ 実装評価

### ✅ 良かった点
1. [良い点1: 例: Design Specに忠実に実装されている]
2. [良い点2: 例: エッジケースへの配慮がある]
3. [良い点3]

### ⚠️ 改善が必要な点
1. [改善点1: 例: XXXメソッドが長すぎる（50行）]
   - **対処**: [メソッド分割案]
2. [改善点2]

### 💡 オプショナルな改善提案
これらは「あれば良い」レベルで、今回は実施しなくても可：
- [提案1: 例: 将来的にはXXXパターン適用を検討]
- [提案2]

---

## 3️⃣ 修正内容

### 修正したファイル

#### `[ファイルパス1]`
**行数**: [XX-YY行]
**修正理由**: [なぜ修正したか]

**Before**:
```python
# 修正前のコード
```

**After**:
```python
# 修正後のコード
```

**影響範囲**: [この修正がどこに影響するか]

---

#### `[ファイルパス2]`
（同様に記載）

---

### 修正なしの項目
以下は修正不要と判断しました（理由も記載）：
- [項目1: 例: XXXの命名 - 既存コードベースと一貫しているため]

---

## 4️⃣ テスト実行結果

### 全テスト実行
```bash
pytest tests/ -v

# 結果
✅ 141 passed in X.XXs
```

**または失敗がある場合**:
```bash
❌ 139 passed, 2 failed
  - tests/mindmap/test_xxx.py::test_yyy
    [エラー内容と原因分析]
    [修正内容]
```

### カバレッジ確認（任意）
```bash
pytest tests/ --cov=ui.mindmap --cov-report=term

# 結果
- 新規コードカバレッジ: XX%
- 重要パスカバレッジ: 100%
```

---

## 5️⃣ 残存リスク・技術的負債

### ⚠️ 残存リスク
今回対応しなかった、将来的に問題になる可能性がある事項：

| リスク | 深刻度 | 対応タイミング |
|--------|--------|---------------|
| [例: 大量ノード時のパフォーマンス未検証] | 中 | Phase 4でテスト |
| ... | 高/中/低 | [いつ対応するか] |

**リスクなし**: ✅ 残存リスクはありません

---

### 🏗️ 技術的負債
今回意図的に残した負債（理由も記載）：

| 負債 | 理由 | 返済計画 |
|------|------|---------|
| [例: XXXのハードコード] | [理由: 今回は仕様未確定のため] | [Phase 5で定数化] |

**負債なし**: ✅ 技術的負債はありません

---

## 6️⃣ 次フェーズへの指示

### Gemini（Phase 4）へのテスト指示

#### 📋 テスト実装項目（Phase 1のテスト観点から）
Phase 1で定義されたテスト観点を、Geminiが実装可能な形式に変換：

##### 正常系テスト
```python
# tests/mindmap/test_{{FEATURE_NAME}}.py
def test_{{test_name_1}}(qapp):
    """[テストの目的]."""
    # 1. [準備]
    # 2. [実行]
    # 3. [検証]
    pass
```

- [ ] `test_{{test_name_1}}`: [テスト内容]
- [ ] `test_{{test_name_2}}`: [テスト内容]

##### 異常系テスト
- [ ] `test_error_{{test_name}}`: [テスト内容]

##### エッジケーステスト
- [ ] `test_edge_{{test_name}}`: [テスト内容]

#### 🎯 重点確認項目
- [確認項目1: 例: 1000ノード時のパフォーマンス（< 1秒）]
- [確認項目2]

#### ⚠️ 注意事項
- [注意1: 例: qappフィクスチャを必ず使用すること]
- [注意2]

---

## 7️⃣ Review Report サマリー

### 📊 評価スコア
- **設計適合性**: ⭐⭐⭐⭐⭐ (5/5)
- **コード品質**: ⭐⭐⭐⭐☆ (4/5)
- **保守性**: ⭐⭐⭐⭐⭐ (5/5)
- **セキュリティ**: ⭐⭐⭐⭐⭐ (5/5)
- **テスト容易性**: ⭐⭐⭐⭐☆ (4/5)

### 📝 総評
[総合的な評価コメント。良かった点と改善点を簡潔にまとめる。]

**Phase 3での修正件数**: XX件（小規模修正）

**Phase 4への推奨事項**:
- [推奨1: 例: パフォーマンステストを重点的に]

---

## 🤝 Phase 3完了チェックリスト

洗練完了前に、以下を全て確認してください：

- [ ] コードレビュー完了（.agent/roles/code-reviewer.md 基準）
- [ ] SOLID原則・.agentルール適合確認済み
- [ ] セキュリティ脆弱性チェック済み
- [ ] パフォーマンス問題なし
- [ ] 過剰設計・不要コードの削除済み
- [ ] ドキュメント・コメント適切
- [ ] 全テスト通過

**全てチェックOK？** → `python scripts/task_manager.py complete-phase` を実行してPhase 4へ

---

**洗練完了日時**: `{{END_TIME}}`
**次フェーズ**: Phase 4 (Gemini Testing)
